<!DOCTYPE html> <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Getting to grips with the watershed | Josselin Lefèvre</title> <meta name="author" content="Josselin Lefèvre"> <meta name="description" content="Learn how to performs basic watershed segmentation with Pink"> <meta name="keywords" content="josselin lefevre, hierarchical, hierarchies, bpt"> <link rel="stylesheet" href="/assets/css/bootstrap.min.css?a4b3f509e79c54a512b890d73235ef04"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"> <link defer rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.22.1/dist/bootstrap-table.min.css"> <link rel="stylesheet" href="/assets/css/academicons.min.css?f0b7046b84e425c55f3463ac249818f5"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-github.css?19f3075a2d19613090fe9e16b564e1fe" media="" id="highlight_theme_light"> <link rel="shortcut icon" href="data:image/svg+xml,&lt;svg%20xmlns=%22http://www.w3.org/2000/svg%22%20viewBox=%220%200%20100%20100%22&gt;&lt;text%20y=%22.9em%22%20font-size=%2290%22&gt;%F0%9F%91%A8%F0%9F%8F%BB%E2%80%8D%F0%9F%92%BB&lt;/text&gt;&lt;/svg&gt;"> <link rel="stylesheet" href="/assets/css/main.css?d41d8cd98f00b204e9800998ecf8427e"> <link rel="canonical" href="https://lefevrej.github.io/blog/2024/pink-watershed/"> <link rel="stylesheet" href="/assets/css/jekyll-pygments-themes-native.css?e74e74bf055e5729d44a7d031a5ca6a5" media="none" id="highlight_theme_dark"> <script src="/assets/js/theme.js?96d6b3e1c3604aca8b6134c7afdd5db6"></script> <script src="/assets/js/dark_mode.js?9b17307bb950ffa2e34be0227f53558f"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.1.0/dist/medium-zoom.min.js" integrity="sha256-ZgMyDAIYDYGxbcpJcfUnYwNevG/xi9OHKaR/8GK+jWc=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js?7b30caa5023af4af8408a472dc4e1ebb"></script> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src="/assets/js/distillpub/template.v2.js"></script> <script src="/assets/js/distillpub/transforms.v2.js"></script> <script src="/assets/js/distillpub/overrides.js"></script> </head> <body> <d-front-matter> <script async type="text/json">{
      "title": "Getting to grips with the watershed",
      "description": "Learn how to performs basic watershed segmentation with Pink",
      "published": "January 22, 2024",
      "authors": [
        {
          "author": "Jean Cousty",
          "authorURL": "https://perso.esiee.fr/~coustyj/",
          "affiliations": [
            {
              "name": "ESIEE Paris",
              "url": ""
            }
          ]
        },
        {
          "author": "Josselin Lefèvre",
          "authorURL": "lefevrej.github.io",
          "affiliations": [
            {
              "name": "ESIEE Paris, Thermo Fisher Scientific",
              "url": ""
            }
          ]
        }
        
      ],
      "katex": {
        "delimiters": [
          {
            "left": "$",
            "right": "$",
            "display": false
          },
          {
            "left": "$$",
            "right": "$$",
            "display": true
          }
        ]
      }
    }</script> </d-front-matter> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Josselin </span>Lefèvre</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">About</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">Publications</a> </li> <li class="nav-item "> <a class="nav-link" href="/cv/">CV</a> </li> <li class="nav-item "> <a class="nav-link" href="/teaching/">Teaching</a> </li> <li class="nav-item "> <a class="nav-link" href="/blog/index.html">Blog</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fa-solid fa-moon"></i> <i class="fa-solid fa-sun"></i> </button> </li> </ul> </div> </div> </nav> <progress id="progress" value="0"> <div class="progress-container"> <span class="progress-bar"></span> </div> </progress> </header> <div class="post distill"> <d-title> <h1>Getting to grips with the watershed</h1> <p>Learn how to performs basic watershed segmentation with Pink</p> </d-title><d-byline></d-byline><d-article> <d-contents> <nav class="l-text figcaption"> <h3>Contents</h3> <div><a href="#problem-1-uranium-oxide">Problem 1 Uranium oxide</a></div> <div><a href="#problem-2-segmentation-of-red-blood-cells">Problem 2 Segmentation of red blood cells</a></div> <div><a href="#how-to-watershed-with-pink">How To Watershed with PINK</a></div> </nav> </d-contents> <h2 id="problem-1-uranium-oxide">Problem 1 Uranium oxide</h2> <div class="row"> <div class="col-sm mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/uo-480.webp 480w,/assets/img/uo-800.webp 800w,/assets/img/uo-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/uo.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> <div class="col-sm mt-md-0"> <figure> <picture> <source class="responsive-img-srcset" srcset="/assets/img/uo-480.webp 480w,/assets/img/uo-800.webp 800w,/assets/img/uo-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/uo.png" class="img-fluid rounded z-depth-1" width="100%" height="auto" data-zoomable="" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </div> </div> <ol> <li>Segment all the cells of the attached uranium oxide image.</li> <li>Remove the cells that touch the frame of the image.</li> <li>Give some statistics about the cells (number, average size, etc.).</li> </ol> <h3 id="tools">Tools</h3> <table> <tbody> <tr> <td>- <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/pgm2GA_8c.html" rel="external nofollow noopener" target="_blank">pgm2GA</a> </td> <td>- <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/GAwatershed_8c.html" rel="external nofollow noopener" target="_blank">GAwatershed</a> </td> </tr> <tr> <td>- <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/GA2khalimsky_8c.html" rel="external nofollow noopener" target="_blank">GA2khalimsky</a> </td> <td>- <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/frame_8c.html" rel="external nofollow noopener" target="_blank">frame</a> </td> </tr> <tr> <td>- <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/nbcomp_8c.html" rel="external nofollow noopener" target="_blank">nbcomp</a> </td> <td>- <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/area_8c.html" rel="external nofollow noopener" target="_blank">area</a> </td> </tr> </tbody> </table> <blockquote> <p><strong>Hint</strong>: you can use the <a href="#how-to-watershed-with-pink">How to Watershed with PINK</a> section below to find some useful pink commands <img class="emoji" title=":wink:" alt=":wink:" src="https://github.githubassets.com/images/icons/emoji/unicode/1f609.png" height="20" width="20"></p> </blockquote> <h2 id="problem-2-segmentation-of-red-blood-cells">Problem 2 Segmentation of red blood cells</h2> <style>.slider-example-focus{width:50%!important}.slider-example-focus:focus{outline:0}.center-content{display:flex;justify-content:center}</style> <div class="center-content"> <img-comparison-slider class="slider-example-focus"> <figure slot="first"> <picture> <source class="responsive-img-srcset" srcset="/assets/img/bloodcells-480.webp 480w,/assets/img/bloodcells-800.webp 800w,/assets/img/bloodcells-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/bloodcells.png" class="img-fluid rounded z-depth-1 custom-image-size" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> <figure slot="second"> <picture> <source class="responsive-img-srcset" srcset="/assets/img/bloodcells_ws-480.webp 480w,/assets/img/bloodcells_ws-800.webp 800w,/assets/img/bloodcells_ws-1400.webp 1400w," sizes="95vw" type="image/webp"></source> <img src="/assets/img/bloodcells_ws.png" class="img-fluid rounded z-depth-1 custom-image-size" width="100%" height="auto" onerror="this.onerror=null; $('.responsive-img-srcset').remove();"> </picture> </figure> </img-comparison-slider> </div> <ol> <li>Segment all the red blood cells in the attached bloodCells image.</li> <li>Remove the ones that touch the edge of the image.</li> <li>Separate the cells that are touching each other.</li> <li>Give some statistics about the globules (number, average size).</li> </ol> <blockquote> <p><strong>Hint</strong>: step 3 is tricky. It needs the notion of a <a href="#distance-map"><strong>distance map</strong></a> of a binary object.</p> </blockquote> <h2 id="how-to-watershed-with-pink">How to Watershed with PINK</h2> <h3 id="key-instructions">Key instructions</h3> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># To transform an image into a weighted edge graph:</span>
pgm2GA im.pgm 0 relief.ga
</code></pre></div></div> <blockquote class="block-tip"> <h5 id="tip">TIP</h5> <p>The second argument (here 0) indicates how we proceed to <strong>weight</strong> the edges (maximum / minimum or intensity difference between pixels at the ends of each edge).</p> <p><em>Is the choice of one weighting function more relevant than another? In which cases? What difference could it make to the output?</em></p> </blockquote> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># To calculate a Watershed Line of a weighted edge graph</span>
GAwatershed relief.ga watershed.ga

<span class="c"># To visualize the result, we switch to the Khalimsky grid</span>
GA2khalimsky watershed.ga 0 watershed.pgm
</code></pre></div></div> <blockquote class="block-tip"> <h5 id="tip-1">TIP</h5> <p>To superimpose a segmentation (in the form of a binary image) on a grayscale image, we can use <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/surimp_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">surimp</code></a> <strong>be careful the two images must be the same size</strong>.</p> </blockquote> <p>To resize an image to the desired size we can use zoom or make the image <code class="language-plaintext highlighter-rouge">img.pgm</code> undergo a transition to a weighted graph and then to the Khalimsky grid.</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pgm2GA img.pgm 0 img.ga
GA2khalimsky img.ga 0  imgRightSize.pgm
</code></pre></div></div> <h3 id="distance-map">Distance map</h3> <p>Basically, the distance map to a subset \(X\) of the space \(E\) is the image \(D_X\) on \(E\) defined, for every pixel \(x\) in \(E\) by \(D_X(x) = \min \{ \, d(x,y) \, | \, y \in X \, \}\) where \(d(x,y)\) denotes the (Euclidean) distance between \(x\) and \(y\).</p> <p>The the distance map to \(X\) is an image where the value of each pixel \(x\) is the distance from this point to the closest point which belongs to the set \(X\).</p> <p>To obtain the distance map of an object in Pink you can use the command <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/dist_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">dist</code></a> for example with the command:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>dist X.pgm 1 distMapToX.pgm
</code></pre></div></div> <p>If needed you can convert the resulting image to a byte image (i.e., an image with values between 0 and 255) with the command:</p> <div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>long2byte distMapToX.pgm  1 distMapToX_Byte.pgm
</code></pre></div></div> <blockquote class="block-warning"> <h5 id="warning">WARNING</h5> <p>If you calculate the map distance on an image that is too large, then the byte conversion will not work. The distances will be too large, resulting in an <a href="https://www.wikiwand.com/en/Integer_overflow" rel="external nofollow noopener" target="_blank">integer overflow</a>.</p> </blockquote> <h3 id="threshold-an-image-interactively">Threshold an image, interactively</h3> <p>Remind of the fantastic interactive <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/seuil_8tcl.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">seuil.tcl</code></a>.</p> <h3 id="filter-an-image">Filter an image…</h3> <ul> <li>with an area closing: <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/areaclosing_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">areaclosing</code></a> </li> <li>with a dynamic closing (depth): <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/heightminima_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">heightminima</code></a> </li> <li>with a volume closing: <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/volmaxima_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">volmaxima</code></a> and <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/inverse_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">inverse</code></a> </li> </ul> <h3 id="compute-statistics">Compute statistics</h3> <ul> <li>To count the number of white pixels in a binary image: <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/area_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">area</code></a> </li> <li>To count the number of connected components in a binary image: <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/nbcomp_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">nbcomp</code></a> </li> </ul> <h3 id="to-obtain-a-black-image-with-a-white-border">To obtain a black image with a white border</h3> <p>Try <a href="https://perso.esiee.fr/~coupriem/Pink/doc/html/frame_8c.html" rel="external nofollow noopener" target="_blank"><code class="language-plaintext highlighter-rouge">frame</code></a>.</p> </d-article> <d-appendix> <d-footnote-list></d-footnote-list> <d-citation-list></d-citation-list> </d-appendix> <d-bibliography src="/assets/bibliography/"></d-bibliography> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Josselin Lefèvre. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="external nofollow noopener">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" rel="external nofollow noopener" target="_blank">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="external nofollow noopener">GitHub Pages</a>. </div> </footer> <script src="/assets/js/bootstrap.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script type="text/javascript">function progressBarSetup(){"max"in document.createElement("progress")?(initializeProgressElement(),$(document).on("scroll",function(){progressBar.attr({value:getCurrentScrollPosition()})}),$(window).on("resize",initializeProgressElement)):(resizeProgressBar(),$(document).on("scroll",resizeProgressBar),$(window).on("resize",resizeProgressBar))}function getCurrentScrollPosition(){return $(window).scrollTop()}function initializeProgressElement(){let e=$("#navbar").outerHeight(!0);$("body").css({"padding-top":e}),$("progress-container").css({"padding-top":e}),progressBar.css({top:e}),progressBar.attr({max:getDistanceToScroll(),value:getCurrentScrollPosition()})}function getDistanceToScroll(){return $(document).height()-$(window).height()}function resizeProgressBar(){progressBar.css({width:getWidthPercentage()+"%"})}function getWidthPercentage(){return getCurrentScrollPosition()/getDistanceToScroll()*100}const progressBar=$("#progress");window.onload=function(){setTimeout(progressBarSetup,50)};</script> <script src="https://cdn.jsdelivr.net/npm/img-comparison-slider@8.0/dist/index.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/swiper@11.0.5/swiper-element-bundle.min.js" integrity="sha256-BPrwikijIybg9OQC5SYFFqhBjERYOn97tCureFgYH1E=" crossorigin="anonymous"></script> </body> </html>